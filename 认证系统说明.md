# 缺陷管理系统 - 认证系统说明

## 功能概述

系统实现了完整的用户认证和权限管理功能：

### 1. 用户登录
- 支持用户名+密码登录
- 使用 JWT (JSON Web Token) 进行身份认证
- 登录成功后自动保存用户信息和权限到本地存储

### 2. 未登录状态
- 默认为**游客（guest）**角色
- 只有**只读权限**，无法进行任何写操作
- 右上角显示"登录"按钮

### 3. 已登录状态
- 显示用户信息和当前角色
- 可以查看个人信息
- 可以修改密码
- 可以退出登录

### 4. 密码管理
- 新建用户时，如果不指定密码，**默认密码为邮箱地址**
- 用户可以自行修改密码
- 密码使用 **bcrypt** 加密存储，安全可靠
- 修改密码后需要重新登录

## 初始账号

系统预置了 1 个管理员账号：

| 用户名 | 密码 | 邮箱 | 角色 | 权限说明 |
|--------|------|------|------|----------|
| admin | admin123 | admin@example.com | 管理员 | 所有权限 ✓✓✓✓✓ |

**安全提示**：首次登录后请立即修改密码！

其他用户需要管理员在"用户管理"页面创建。

## 使用流程

### 1. 首次访问
访问 http://localhost:11234，系统默认以**游客身份**浏览：
- ✅ 可以查看所有数据
- ❌ 不能新建、编辑、删除任何内容
- 右上角显示"登录"按钮

### 2. 用户登录
点击右上角"登录"按钮：

```
用户名：admin
密码：admin123
```

登录成功后：
- ✅ 根据角色获得相应权限
- ✅ 右上角显示用户信息和角色
- ✅ 可以进行新建、编辑、删除等操作

### 3. 修改密码
点击右上角用户名 → 选择"修改密码"：
- 输入旧密码
- 输入新密码（至少 6 位）
- 确认新密码
- 修改成功后需要重新登录

### 4. 退出登录
点击右上角用户名 → 选择"退出登录"：
- 清除登录状态
- 自动切换为游客身份
- 权限变为只读

### 5. 管理员创建新用户
管理员登录后，在"用户管理"页面：
- 点击"新建用户"
- 填写用户名、邮箱、角色等信息
- **无需填写密码**，系统会自动使用用户名作为默认密码
- 新用户首次登录后可自行修改密码

## 技术实现

### 后端

#### 1. 密码加密 (`auth.py`)
```python
from passlib.context import CryptContext

pwd_context = CryptContext(schemes=["bcrypt"], deprecated="auto")

# 加密密码
hashed_password = hash_password(plain_password)

# 验证密码
is_valid = verify_password(plain_password, hashed_password)
```

#### 2. JWT 令牌
```python
from jose import jwt

# 创建 access token
token = create_access_token(data={
    "sub": username,
    "user_id": user_id,
    "role": role
})

# 解码 token
payload = decode_access_token(token)
```

#### 3. API 接口
- `POST /api/auth/login` - 用户登录
  ```json
  {
    "username": "admin",
    "password": "admin@example.com"
  }
  ```
  
- `POST /api/auth/change-password` - 修改密码
  ```json
  {
    "old_password": "old_pass",
    "new_password": "new_pass"
  }
  ```

### 前端

#### 1. 权限管理 Composable
```typescript
import { usePermissions } from '@/composables/usePermissions'

const {
  currentUser,      // 当前用户信息
  isLoggedIn,       // 是否已登录
  setCurrentUser,   // 设置用户（登录）
  clearCurrentUser, // 清除用户（登出）
  canCreate,        // 是否可以创建
  canUpdate,        // 是否可以更新
  canDelete         // 是否可以删除
} = usePermissions()
```

#### 2. 本地存储
- `localStorage.accessToken` - JWT 令牌
- `localStorage.currentUser` - 用户信息和权限

#### 3. 登录流程
```typescript
// 登录
const response = await authApi.login({ username, password })
localStorage.setItem('accessToken', response.access_token)
setCurrentUser(response.user)

// 登出
clearCurrentUser()
localStorage.removeItem('accessToken')
```

## 数据库变更

### users 表新增字段
```sql
password VARCHAR(255) NOT NULL COMMENT '密码（加密存储）'
```

### 密码哈希示例
```
明文: admin@example.com
加密: $2b$12$qxz.ShubJWI5BZTwXNdZXex5sqGd2zjus8Jr4ob3U9AWvPv.AYlbe
```

## 重新初始化数据库

如果数据库已存在，需要重新初始化以添加密码字段：

```bash
# 登录 MySQL
mysql -u root -pTest@123456

# 删除旧数据库
DROP DATABASE bug_management;

# 退出 MySQL
exit

# 重新执行初始化脚本
mysql -u root -pTest@123456 < /Users/lihui/Work/cursor/dm-brains/bug-server/backend/init_db.sql
```

或者手动添加密码字段：

```sql
USE bug_management;

-- 添加密码字段
ALTER TABLE users ADD COLUMN password VARCHAR(255) NOT NULL DEFAULT '' AFTER email;

-- 更新现有用户的密码（这里需要使用实际的哈希值）
UPDATE users SET password = '$2b$12$...' WHERE username = 'admin';
```

## 安全建议

### 生产环境配置

1. **修改 JWT Secret Key**
   ```python
   # auth.py
   SECRET_KEY = os.getenv("JWT_SECRET_KEY", "your-production-secret-key")
   ```

2. **使用环境变量**
   ```bash
   export JWT_SECRET_KEY="your-very-secure-random-key"
   export TOKEN_EXPIRE_MINUTES=30
   ```

3. **HTTPS**
   - 生产环境必须使用 HTTPS
   - 防止 Token 在传输过程中被窃取

4. **强密码策略**
   - 要求用户设置复杂密码
   - 定期强制修改密码
   - 添加密码强度验证

5. **Token 刷新**
   - 实现 Refresh Token 机制
   - Access Token 设置较短过期时间
   - Refresh Token 设置较长过期时间

6. **登录保护**
   - 添加登录失败次数限制
   - 实现验证码功能
   - 记录登录日志

## 常见问题

### Q1: 忘记密码怎么办？
A: 可以由管理员重置密码，或者直接在数据库中更新密码哈希值。

### Q2: 密码加密不安全？
A: 使用 bcrypt 加密，是业界标准的密码加密算法，安全性很高。

### Q3: Token 过期了怎么办？
A: 当前实现的 Token 有效期为 24 小时，过期后需要重新登录。

### Q4: 如何添加验证码？
A: 可以集成 Google reCAPTCHA 或其他验证码服务。

### Q5: 支持第三方登录吗？
A: 当前不支持，可以后续集成 OAuth2（如 GitHub、Google 登录）。

## 测试场景

### 场景 1：未登录访问
1. 访问 http://localhost:11234
2. 验证：只能查看，不能编辑/删除
3. 右上角显示"登录"按钮

### 场景 2：管理员登录
1. 点击"登录"，输入 `admin` / `admin@example.com`
2. 验证：可以新建、编辑、删除所有内容
3. 可以管理用户

### 场景 3：产品/开发/测试登录
1. 使用对应账号登录
2. 验证：用户管理页面无"新建"/"编辑"/"删除"按钮
3. 其他页面功能正常

### 场景 4：游客登录
1. 使用 `guest` / `guest@example.com` 登录
2. 验证：所有页面都是只读状态

### 场景 5：修改密码
1. 登录后，点击右上角用户名
2. 选择"修改密码"
3. 输入旧密码和新密码
4. 修改成功后重新登录

### 场景 6：管理员创建用户
1. 管理员登录
2. 进入"用户管理"页面
3. 新建用户，只填写基本信息，不填密码
4. 新用户使用用户名作为密码登录
5. 登录后修改密码

## 未来优化

- [ ] 实现 Refresh Token 机制
- [ ] 添加登录失败次数限制
- [ ] 实现验证码功能
- [ ] 支持第三方登录（OAuth2）
- [ ] 添加密码强度验证
- [ ] 实现找回密码功能
- [ ] 添加登录日志记录
- [ ] 实现 API 级别的权限验证中间件

