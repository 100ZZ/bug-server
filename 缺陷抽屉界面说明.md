# 缺陷抽屉界面说明

## 📋 功能概述

已将缺陷的创建/编辑界面从对话框（Dialog）升级为抽屉（Drawer），采用左右分栏设计，提供更大的编辑空间和更好的用户体验。

## 🎨 界面布局

### 整体结构

```
┌─────────────────────────────────────────────────────────────┐
│  新建缺陷 / 编辑缺陷                                   [×]    │
├─────────────────────────────────────────────────────────────┤
│                                                               │
│  ┌─────────────────────────┐  ┌──────────────────────────┐ │
│  │ 左侧：内容编辑区         │  │ 右侧：元数据字段          │ │
│  │                         │  │                          │ │
│  │ • 标题                   │  │ • 项目 *                 │ │
│  │ • 缺陷描述（支持粘贴图片）│  │ • 状态 *                 │ │
│  │ • 重现步骤（支持粘贴图片）│  │ • 处理人                 │ │
│  │ • 预期结果               │  │ • 版本                   │ │
│  │ • 实际结果               │  │ • 迭代/里程碑            │ │
│  │                         │  │ • 缺陷类型 *             │ │
│  │                         │  │ • 严重程度 *             │ │
│  │                         │  │ • 优先级 *               │ │
│  │                         │  │ • 预估工时（小时）        │ │
│  │                         │  │ • 开始日期               │ │
│  │                         │  │ • 截止日期               │ │
│  │                         │  │ • 环境信息               │ │
│  └─────────────────────────┘  └──────────────────────────┘ │
│                                                               │
├─────────────────────────────────────────────────────────────┤
│                                         [取消] [保存]         │
└─────────────────────────────────────────────────────────────┘
```

## ✨ 核心功能

### 1. 左侧内容编辑区

**字段列表：**

| 字段名 | 类型 | 是否必填 | 功能特性 |
|--------|------|----------|----------|
| 标题 | 单行文本 | ✅ 必填 | 缺陷标题，简明扼要 |
| 缺陷描述 | 多行文本 | ❌ 可选 | 10行，支持粘贴截图（Ctrl+V） |
| 重现步骤 | 多行文本 | ❌ 可选 | 8行，支持粘贴截图（Ctrl+V） |
| 预期结果 | 多行文本 | ❌ 可选 | 3行 |
| 实际结果 | 多行文本 | ❌ 可选 | 3行 |

**图片粘贴功能：**
- ✅ 在"缺陷描述"和"重现步骤"输入框中按 `Ctrl+V` 粘贴截图
- ✅ 自动转换为 Base64 格式保存
- ✅ 在输入框下方显示图片预览
- ✅ 每张图片右上角有删除按钮
- ✅ 在文本中自动添加 `[图片N]` 标记

### 2. 右侧元数据字段

**字段列表：**

| 字段名 | 类型 | 是否必填 | 说明 |
|--------|------|----------|------|
| 项目 | 下拉选择 | ✅ 必填 | 选择缺陷所属项目 |
| 状态 | 下拉选择 | ✅ 必填 | 待处理/进行中/已解决/已关闭/重新打开/待定 |
| 处理人 | 下拉选择 | ❌ 可选 | 可清空，选择负责人 |
| 版本 | 文本输入 | ❌ 可选 | 发现缺陷的版本号 |
| 迭代/里程碑 | 文本输入 | ❌ 可选 | 所属迭代或模块 |
| 缺陷类型 | 下拉选择 | ✅ 必填 | 缺陷/故障/改进/任务 |
| 严重程度 | 下拉选择 | ✅ 必填 | 致命/严重/一般/轻微/建议 |
| 优先级 | 下拉选择 | ✅ 必填 | 阻塞/严重/主要/次要/轻微 |
| 预估工时 | 数字输入 | ❌ 可选 | 单位：小时，支持小数（如 2.5） |
| 开始日期 | 日期选择 | ❌ 可选 | 计划开始修复的日期 |
| 截止日期 | 日期选择 | ❌ 可选 | 期望完成的日期 |
| 环境信息 | 多行文本 | ❌ 可选 | 操作系统、浏览器等环境信息 |

## 🎯 使用场景

### 场景 1：创建新缺陷

1. 点击"新建缺陷"按钮
2. 填写左侧的标题和描述
3. 在描述框中按 `Ctrl+V` 粘贴截图
4. 填写右侧的元数据（项目、状态等）
5. 点击"保存"按钮

### 场景 2：编辑现有缺陷

1. 在缺陷列表点击"编辑"按钮
2. 抽屉打开，显示现有数据
3. 修改需要的字段
4. 点击"保存"按钮

### 场景 3：粘贴多张截图

1. 在描述框中输入部分文字
2. 按 `Ctrl+V` 粘贴第一张图片
3. 继续输入文字
4. 再次按 `Ctrl+V` 粘贴第二张图片
5. 图片会依次显示在预览区域
6. 文本中自动标记 `[图片1]`、`[图片2]` 等

## 💡 技术实现

### 组件结构

```vue
<el-drawer size="80%">
  <div class="bug-drawer-content">
    <!-- 左侧 flex: 1 -->
    <div class="drawer-left">
      <el-form label-position="top">
        <!-- 内容字段 -->
      </el-form>
    </div>
    
    <!-- 右侧固定宽度 320px -->
    <div class="drawer-right">
      <el-form label-position="top">
        <!-- 元数据字段 -->
      </el-form>
    </div>
  </div>
  
  <template #footer>
    <!-- 底部按钮 -->
  </template>
</el-drawer>
```

### 图片粘贴处理

```typescript
const handlePaste = (event: ClipboardEvent) => {
  const items = event.clipboardData?.items
  if (!items) return
  
  for (let i = 0; i < items.length; i++) {
    const item = items[i]
    if (item.type.indexOf('image') !== -1) {
      const file = item.getAsFile()
      if (file) {
        const reader = new FileReader()
        reader.onload = (e) => {
          const base64 = e.target?.result as string
          pastedImages.value.push(base64)
          // 在描述中添加图片引用标记
          const imageRef = `[图片${pastedImages.value.length}]`
          formData.description += `\n${imageRef}\n`
        }
        reader.readAsDataURL(file)
      }
    }
  }
}
```

### 样式特点

1. **左右分栏布局**
   - 左侧：`flex: 1`（自适应）
   - 右侧：`width: 320px`（固定宽度）
   - 间距：`gap: 24px`

2. **滚动优化**
   - 左右两栏独立滚动
   - 自定义滚动条样式（宽度 6px）
   - 平滑滚动体验

3. **响应式设计**
   - 屏幕宽度 < 1200px 时，切换为上下布局
   - 移动端友好

## 📊 字段映射

### 前端字段 → 后端字段

| 前端表单字段 | 后端 API 字段 | 数据库字段 |
|-------------|--------------|-----------|
| title | title | title |
| description | description | description |
| steps_to_reproduce | steps_to_reproduce | steps_to_reproduce |
| expected_result | expected_result | expected_result |
| actual_result | actual_result | actual_result |
| project_id | project_id | project_id |
| status | status | status |
| assignee_id | assignee_id | assignee_id |
| version | version | version |
| module | module | module |
| type | type | type |
| severity | severity | severity |
| priority | priority | priority |
| estimated_hours | estimated_hours | estimated_hours |
| start_date | start_date | - (新增) |
| due_date | due_date | due_date |
| environment | environment | environment |

## 🚀 优势对比

### 对话框 vs 抽屉

| 特性 | 对话框 (旧) | 抽屉 (新) |
|------|-----------|----------|
| 展示空间 | 800px 固定宽度 | 80% 屏幕宽度 |
| 内容组织 | 单列垂直排列 | 左右分栏 |
| 图片粘贴 | ❌ 不支持 | ✅ 支持 |
| 表单体验 | 拥挤，需滚动 | 宽敞，分区清晰 |
| 视觉焦点 | 居中遮挡 | 右侧滑出，不遮挡主界面 |

## 🔄 数据流程

```
用户操作 → 表单数据 → API 请求 → 后端处理 → 数据库保存
   ↓
图片粘贴 → Base64 转换 → pastedImages 数组 → 显示预览
   ↓
保存时：formData + pastedImages → 组合发送 → 后端保存
```

## 📝 注意事项

1. **必填字段验证**
   - 项目（project_id）
   - 标题（title）
   - 缺陷类型（type）
   - 严重程度（severity）
   - 优先级（priority）
   - 状态（status）

2. **图片处理**
   - 目前图片保存为 Base64 格式
   - 未来可升级为：上传到服务器 → 返回 URL → 保存 URL

3. **数据清理**
   - 创建新缺陷时，清空 pastedImages 数组
   - 编辑缺陷时，重新初始化 pastedImages

4. **报告人自动填充**
   - 使用 `getCurrentUser()` 获取当前登录用户
   - 如果未登录，默认使用 ID 为 1 的用户

## 🎨 UI 细节

- **标题输入框**：`size="large"` 更突出
- **表单标签**：`label-position="top"` 垂直排列
- **文本域行数**：
  - 描述：10 行
  - 重现步骤：8 行
  - 预期/实际结果：3 行
  - 环境信息：2 行
- **图片预览**：150x150px，带删除按钮
- **抽屉大小**：80% 屏幕宽度
- **右侧宽度**：320px 固定

## 🔮 未来优化方向

1. **富文本编辑器**
   - 集成 TinyMCE 或 Quill
   - 支持格式化、代码高亮

2. **图片上传优化**
   - 上传到服务器/OSS
   - 支持拖拽上传
   - 图片压缩

3. **实时协作**
   - 多人同时编辑提示
   - WebSocket 实时更新

4. **历史版本**
   - 记录每次修改
   - 支持回滚

5. **自动保存**
   - 定时保存草稿
   - 防止数据丢失

