# 项目过滤功能使用说明

## 功能概述

项目过滤功能允许用户选择一个项目后，所有页面都只显示和操作该项目的相关信息。这是一个全局的项目上下文功能。

## 已实现的页面

- ✅ **TestTaskPage.vue** - 测试任务页面（已完成示例实现）

## 如何应用到其他页面

### 1. 在模板中添加项目选择器组件

在页面顶部（通常在第一个 `<el-card>` 之前）添加：

```vue
<template>
  <div class="your-page">
    <!-- 项目选择器 -->
    <ProjectSelector />
    
    <!-- 其他内容 -->
    ...
  </div>
</template>
```

### 2. 导入必要的依赖

在 `<script setup>` 中添加：

```typescript
import ProjectSelector from '@/components/ProjectSelector.vue'
import { useProjectContext } from '@/composables/useProjectContext'
// 或者使用辅助函数
import { useProjectFilter } from '@/composables/useProjectFilter'
```

### 3. 使用项目上下文

#### 方式一：使用 useProjectContext（完整控制）

```typescript
const {
  getCurrentProjectId,
  getCurrentProjectName,
  hasProjectSelected
} = useProjectContext()
```

#### 方式二：使用 useProjectFilter（简化版）

```typescript
const {
  getCurrentProjectId,
  getCurrentProjectName,
  hasProjectSelected,
  applyProjectFilter,
  getProjectIdForForm,
  watchProjectChange
} = useProjectFilter()
```

### 4. 修改 API 调用，自动应用项目过滤

在加载数据的函数中：

```typescript
const loadData = async () => {
  const params: any = {}
  
  // 方式一：手动应用
  if (hasProjectSelected.value && getCurrentProjectId.value) {
    params.project_id = getCurrentProjectId.value
  }
  
  // 方式二：使用辅助函数
  applyProjectFilter(params)
  
  // 其他过滤条件
  if (filters.value.keyword) params.keyword = filters.value.keyword
  
  const response = await yourApi(params)
  // ...
}
```

### 5. 禁用项目选择下拉框

在模板中：

```vue
<el-select 
  v-model="filters.project_id" 
  placeholder="选择项目" 
  :clearable="!hasProjectSelected"
  :disabled="hasProjectSelected"
  @change="loadData"
>
  <el-option v-for="project in projects" :key="project.id" :label="project.name" :value="project.id" />
</el-select>
```

### 6. 在表单中自动设置项目ID并禁用选择

在创建/编辑表单中：

```vue
<el-form-item label="选择项目" required>
  <el-select 
    v-model="formData.project_id" 
    placeholder="选择项目" 
    :disabled="hasProjectSelected"
  >
    <el-option v-for="project in projects" :key="project.id" :label="project.name" :value="project.id" />
  </el-select>
  <div v-if="hasProjectSelected" style="font-size: 12px; color: #909399; margin-top: 4px;">
    当前已选择项目：{{ getCurrentProjectName }}
  </div>
</el-form-item>
```

在创建函数中：

```typescript
const handleCreate = async () => {
  // 方式一：手动设置
  const projectId = hasProjectSelected.value && getCurrentProjectId.value 
    ? getCurrentProjectId.value 
    : (projects.value[0]?.id || 0)
  
  // 方式二：使用辅助函数
  const projectId = getProjectIdForForm(projects.value[0]?.id || 0)
  
  formData.value = {
    ...formData.value,
    project_id: projectId
  }
  // ...
}
```

### 7. 监听项目切换事件

在 `onMounted` 中：

```typescript
import { onMounted, onUnmounted } from 'vue'

const handleProjectChanged = () => {
  // 项目切换后，自动刷新数据
  loadData()
}

onMounted(() => {
  loadData()
  
  // 监听项目切换事件
  window.addEventListener('project:changed', handleProjectChanged)
})

onUnmounted(() => {
  window.removeEventListener('project:changed', handleProjectChanged)
})
```

或者使用辅助函数：

```typescript
onMounted(() => {
  loadData()
  
  // 使用辅助函数会自动处理清理
  const cleanup = watchProjectChange(() => {
    loadData()
  })
  
  onUnmounted(() => {
    cleanup()
  })
})
```

## 需要修改的页面列表

以下页面需要应用项目过滤功能：

1. **ApiTestPage.vue** - 接口测试页面
2. **ApiFlowPage.vue** - 流程测试页面
3. **CodeScanPage.vue** - 代码扫描页面
4. **ApiEnvironmentPage.vue** - 环境管理页面
5. **TestCasesPage.vue** - 用例管理页面
6. **BugsPage.vue** - 缺陷管理页面

## 注意事项

1. **项目选择器位置**：建议在每个页面的顶部统一位置添加 `<ProjectSelector />` 组件
2. **数据刷新**：项目切换后，所有页面都应该自动刷新数据
3. **表单验证**：确保在项目上下文中，表单的项目ID字段被正确设置且不可编辑
4. **权限检查**：确保用户对选中的项目有相应的操作权限

## 测试要点

1. ✅ 选择项目后，所有页面只显示该项目的相关数据
2. ✅ 项目选择下拉框被禁用
3. ✅ 创建/编辑表单中项目字段被自动设置且禁用
4. ✅ 切换项目后，数据自动刷新
5. ✅ 取消项目过滤后，可以正常选择其他项目
6. ✅ 刷新页面后，项目上下文被正确恢复

