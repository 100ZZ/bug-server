version: '3.8'

services:
  # MySQL 8.x 数据库服务
  mysql:
    image: ${MYSQL_IMAGE:-100zz/test-mysql:8.0.20}
    container_name: bug-server-mysql${CONTAINER_SUFFIX:-}
    restart: always
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD:-Test@123456}
      MYSQL_DATABASE: ${MYSQL_DATABASE:-bug_management}
      MYSQL_USER: ${MYSQL_USER:-buguser}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD:-Test@123456}
      TZ: Asia/Shanghai
    ports:
      - "${MYSQL_PORT:-33306}:3306"
    volumes:
      - bug_mysql_data:/var/lib/mysql
      - ../backend/init_db.sql:/docker-entrypoint-initdb.d/01_init_db.sql:ro
      - ./02_init_data.sql:/docker-entrypoint-initdb.d/02_init_data.sql:ro
    command: 
      - --character-set-server=utf8mb4
      - --collation-server=utf8mb4_unicode_ci
      - --default-authentication-plugin=mysql_native_password
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-p${MYSQL_ROOT_PASSWORD:-Test@123456}"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - bug-server-network

  # 后端服务
  backend:
    build:
      context: ..
      dockerfile: docker/Dockerfile.backend
    image: bug-backend:${IMAGE_TAG:-latest}
    container_name: bug-server-backend${CONTAINER_SUFFIX:-}
    restart: always
    environment:
      DB_HOST: mysql
      DB_PORT: 3306
      DB_USER: ${MYSQL_USER:-buguser}
      DB_PASSWORD: ${MYSQL_PASSWORD:-Test@123456}
      DB_NAME: ${MYSQL_DATABASE:-bug_management}
      SONAR_URL: ${SONAR_URL:-http://sonarqube:9000}
      SONAR_TOKEN: ${SONAR_TOKEN:-}
    ports:
      - "${BACKEND_PORT:-43211}:43211"
    volumes:
      - ../backend:/app
    depends_on:
      - mysql
    networks:
      - bug-server-network
    command: sh -c "sleep 15 && python -m uvicorn app:app --host 0.0.0.0 --port 43211 --reload"

  # 前端服务
  frontend:
    build:
      context: ..
      dockerfile: docker/Dockerfile.frontend
      args:
        NPM_REGISTRY: ${NPM_REGISTRY:-}
        YARN_REGISTRY: ${YARN_REGISTRY:-}
    image: bug-frontend:${IMAGE_TAG:-latest}
    container_name: bug-server-frontend${CONTAINER_SUFFIX:-}
    restart: always
    ports:
      - "${FRONTEND_PORT:-11234}:11234"
    volumes:
      - ../frontend:/app
      - /app/node_modules
    environment:
      - DOCKER_ENV=true
    depends_on:
      - backend
    networks:
      - bug-server-network
    command: npm run dev -- --host 0.0.0.0

  # SonarQube 代码质量扫描服务
  sonarqube:
    image: 100zz/sonarqube:7.7-community
    container_name: bug-server-sonarqube${CONTAINER_SUFFIX:-}
    restart: always
    user: "999:999"
    environment:
      SONAR_JDBC_URL: jdbc:mysql://mysql:3306/${SONAR_DB_NAME:-sonarqube}?useUnicode=true&characterEncoding=utf8&rewriteBatchedStatements=true&useConfigs=maxPerformance&useSSL=false
      SONAR_JDBC_USERNAME: ${MYSQL_USER:-buguser}
      SONAR_JDBC_PASSWORD: ${MYSQL_PASSWORD:-Test@123456}
      SONAR_ES_BOOTSTRAP_CHECKS_DISABLE: "true"
      TZ: Asia/Shanghai
    ports:
      - "${SONAR_PORT:-9000}:9000"
    volumes:
      - bug_sonarqube_data:/opt/sonarqube/data
      - bug_sonarqube_extensions:/opt/sonarqube/extensions
      - bug_sonarqube_logs:/opt/sonarqube/logs
    depends_on:
      - mysql
    networks:
      - bug-server-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/api/system/status"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

volumes:
  bug_mysql_data:
    driver: local
  bug_sonarqube_data:
    driver: local
  bug_sonarqube_extensions:
    driver: local
  bug_sonarqube_logs:
    driver: local

networks:
  bug-server-network:
    driver: bridge

