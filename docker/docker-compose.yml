version: '3.8'

services:
  # MySQL 8.x 数据库服务（为 bug_management 提供数据库）
  mysql:
    image: ${MYSQL_IMAGE:-100zz/test-mysql:8.0.20}
    container_name: bug-server-mysql${CONTAINER_SUFFIX:-}
    restart: always
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD:-Test@123456}
      MYSQL_DATABASE: ${MYSQL_DATABASE:-bug_management}
      MYSQL_USER: ${MYSQL_USER:-buguser}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD:-Test@123456}
      TZ: Asia/Shanghai
    ports:
      - "${MYSQL_PORT:-33306}:3306"
    volumes:
      - bug_mysql_data:/var/lib/mysql
      - ../backend/init_db.sql:/docker-entrypoint-initdb.d/01_init_db.sql:ro
      - ./02_init_data.sql:/docker-entrypoint-initdb.d/02_init_data.sql:ro
    command: 
      - --character-set-server=utf8mb4
      - --collation-server=utf8mb4_unicode_ci
      - --default-authentication-plugin=mysql_native_password
      - --sort_buffer_size=8M
      - --max_sort_length=8192
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-p${MYSQL_ROOT_PASSWORD:-Test@123456}"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - bug-server-network

  # 后端服务
  backend:
    build:
      context: ..
      dockerfile: docker/Dockerfile.backend
    image: bug-backend:${IMAGE_TAG:-latest}
    container_name: bug-server-backend${CONTAINER_SUFFIX:-}
    restart: always
    environment:
      DB_HOST: mysql
      DB_PORT: 3306
      DB_USER: ${MYSQL_USER:-buguser}
      DB_PASSWORD: ${MYSQL_PASSWORD:-Test@123456}
      DB_NAME: ${MYSQL_DATABASE:-bug_management}
      # 文件上传目录配置（Docker 环境映射到宿主机目录）
      UPLOAD_DIR: /data/uploads
      # 缺陷图片目录配置（Docker 环境映射到宿主机目录）
      BUG_IMAGE_DIR: /data/images
      TZ: Asia/Shanghai
    ports:
      - "${BACKEND_PORT:-43211}:43211"
    volumes:
      - ../backend:/app
      # 文件上传持久化存储 - 映射到宿主机目录，方便直接查看
      # 目录结构：/opt/bug-uploads/local/ 和 /opt/bug-uploads/flow/
      - ${UPLOAD_HOST_DIR:-/opt/bug-uploads}:/data/uploads
      # 缺陷图片持久化存储 - 映射到宿主机目录
      # 目录结构：/opt/bug-images/{缺陷编号}/{图片文件}
      - ${BUG_IMAGE_DIR:-/opt/bug-images}:/data/images
    depends_on:
      - mysql
    networks:
      - bug-server-network
    command: sh -c "sleep 15 && python -m uvicorn app:app --host 0.0.0.0 --port 43211 --reload"

  # 前端服务
  frontend:
    build:
      context: ..
      dockerfile: docker/Dockerfile.frontend
      args:
        NPM_REGISTRY: ${NPM_REGISTRY:-}
        YARN_REGISTRY: ${YARN_REGISTRY:-}
    image: bug-frontend:${IMAGE_TAG:-latest}
    container_name: bug-server-frontend${CONTAINER_SUFFIX:-}
    restart: always
    ports:
      - "${FRONTEND_PORT:-11234}:11234"
    volumes:
      - ../frontend:/app
      - /app/node_modules
    environment:
      - DOCKER_ENV=true
    depends_on:
      - backend
    networks:
      - bug-server-network
    command: npm run dev -- --host 0.0.0.0

volumes:
  bug_mysql_data:
    driver: local

networks:
  bug-server-network:
    driver: bridge
    ipam:
      config:
        - subnet: 10.8.0.0/24

